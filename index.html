<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ouBank Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(160deg, #000000, #0d0d0d, #4c1d95, #06b6d4, #0d0d0d, #000000);
  background-size: 300% 300%;
  animation: gradientMove 12s ease infinite;
  color: white;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  user-select: none;
}
@keyframes gradientMove { 0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;} }
.animated-bg { background-size: 300% 300%; animation: gradientMove 12s ease infinite; }
.screen { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: flex-end; padding: 4vw; text-align: left; }
.welcome-text { font-size: 6vw; font-weight: bold; line-height: 1.3; text-shadow: 0 0.5vw 2vw rgba(0,0,0,0.6); animation: fadeInUp 1s ease; }
@keyframes fadeInUp { from{transform:translateY(10vw);opacity:0;}to{transform:translateY(0);opacity:1;} }
.overlay-bg { position:absolute; inset:0; background:rgba(0,0,0,0.85); opacity:0; animation: fadeInBg 0.8s forwards; z-index:5; }
@keyframes fadeInBg { from{opacity:0;}to{opacity:1;} }
.payment { display:flex; flex-direction:column; height:100%; animation: fadeInUp 0.8s ease; position:relative; z-index:10; pointer-events:auto; }
.top-half, .bottom-half { flex:1; display:flex; justify-content:center; align-items:center; flex-direction:column; }
.top-half .centered { margin-top: 40%; font-size:5vw; text-align: center; }
.divider { display:flex; align-items:center; width:100%; color: rgba(255,255,255,0.8); margin-top:2vh; margin-bottom:2vh; }
.divider-line { flex:1; height:0.2vw; background: rgba(255,255,255,0.4); }
.divider span { margin:0 2vw; font-size:4vw; }
.qr-block { background: rgba(0,0,0,0.6); border-radius:4vw; padding:4vw; text-align:center; backdrop-filter:blur(6px); width:80vw; max-width:400px; }
.qr { width:60vw; height:60vw; margin:auto; display:flex; justify-content:center; align-items:center; border-radius:3vw; overflow:hidden; background:white; }
.qr img { width:90%; height:90%; }
.qr-block .label { margin-top:2vw; font-size:4vw; }
.qr-block .id { font-size:3vw; color:gray; margin-top:1vw; }
.row { position:absolute; top:6vw; left:4vw; right:4vw; display:flex; justify-content:space-between; }
.amount, .product { cursor:pointer; pointer-events:auto; -webkit-tap-highlight-color:transparent; }
.amount div:first-child, .product div:first-child { font-size:3vw; opacity:0.7; }
.amount div:last-child { font-size:5vw; font-weight:bold; }
.product div:last-child { font-size:4vw; font-weight:bold; }
.overlay { position:absolute; inset:0; background:black; display:flex; justify-content:center; align-items:center; flex-direction:column; color:white; z-index:200; padding:5vw; }
svg { width:40vw; height:40vw; }
.circle { fill:none; stroke-width:4vw; stroke-linecap:round; stroke-dasharray:280; stroke-dashoffset:70; transform-origin:50% 50%; }
.spin { animation: spin 1s linear 3; }
@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
.check, .cross { stroke-width:4vw; stroke-linecap:round; fill:none; stroke-dasharray:100; stroke-dashoffset:100; opacity:0; }
.draw { animation: draw 0.8s forwards; }
@keyframes draw { to{stroke-dashoffset:0;opacity:1;} }
.modal { position:absolute; inset:0; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:300; padding:5vw; }
.modal-content { background:#1f1f1f; padding:4vw; border-radius:4vw; width:90vw; max-width:400px; overflow-y:auto; text-align:center; }
.modal-content h3 { margin-bottom:3vw; font-size:5vw; }
.modal-content div { margin-bottom:2vw; font-size:4vw; }
button { margin-top:3vw; padding:3vw 5vw; border:none; border-radius:2vw; background:#4c1d95; color:white; font-size:4vw; cursor:pointer; }
.logo-container { position:absolute; top:4vw; left:4vw; display:flex; gap:2vw; align-items:center; }
.logo-circle { width:12vw; height:12vw; border-radius:50%; background: linear-gradient(135deg,#c084fc,#06b6d4); display:flex; justify-content:center; align-items:center; font-size:5vw; font-weight:bold; color:#000; cursor:pointer; }
.info-btn { width:8vw; height:8vw; border-radius:50%; background: rgba(255,255,255,0.15); display:flex; justify-content:center; align-items:center; cursor:pointer; font-weight:bold; backdrop-filter: blur(6px); font-size:4vw; }
.check-twitter { width:6vw; height:6vw; cursor:pointer; }
#paid-amount { font-size:10vw; margin-top:4vw; color:#8b5cf6; font-weight:bold; opacity:0; text-align:center; }
</style>
</head>
<body>
<div id="screen" class="screen"></div>
<script>
const SHOW_CHECK = 1;
const PRODUCTS = [
  { id:"1001", title:"Кофе латте", price:149, qr:"https://placekitten.com/200/200" },
  { id:"1002", title:"Бутерброд", price:199, qr:"https://placekitten.com/210/210" },
  { id:"1003", title:"Чипсы", price:79, qr:"https://placekitten.com/220/220" }
];
let currentProduct=null, amountClicks=0, titleClicks=0;

function showHome(){
  const screen=document.getElementById("screen");
  screen.innerHTML=`
    <div id="welcome" class="welcome-text">Добро пожаловать<br>в терминалы от банка<br>ouBank!</div>
    <div class="logo-container">
      <div class="logo-circle" onclick="openProductInput()">ou</div>
      <div onclick="openProductInput()" style="cursor:pointer;">ouPay</div>
      <div class="info-btn" onclick="openInfo()">i</div>
    </div>`;
}

function openProductInput(){
  const id=prompt("Введите номер товара:");
  const p=PRODUCTS.find(x=>x.id===id);
  if(!p){ alert("Товар не найден"); return; }
  currentProduct=p;
  showPayment();
}

function showPayment(){
  document.getElementById("screen").innerHTML=`
    <div class="overlay-bg animated-bg"></div>
    <div class="payment animated-bg">
      <div class="row">
        <div class="amount" onclick="amountClick()">
          <div>Сумма</div>
          <div>${currentProduct.price} ₽</div>
        </div>
        <div class="product" onclick="titleClick()">
          <div>Товар</div>
          <div>${currentProduct.title}</div>
        </div>
      </div>
      <div class="top-half"><div class="centered">Поднесите телефон для оплаты</div></div>
      <div class="divider"><div class="divider-line"></div><span>или</span><div class="divider-line"></div></div>
      <div class="bottom-half">
        <div class="qr-block">
          <div class="qr"><img src="${currentProduct.qr}"></div>
          <div class="label">Оплатите QR</div>
          <div class="id">#${currentProduct.id}</div>
        </div>
      </div>
    </div>`;
}

function amountClick(){ amountClicks++; setTimeout(()=>amountClicks=0,1500); if(amountClicks>=3){ amountClicks=0; showAnimation("success"); } }
function titleClick(){ titleClicks++; setTimeout(()=>titleClicks=0,1500); if(titleClicks>=3){ titleClicks=0; showAnimation("fail"); } }

async function playBeep(type){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  await ctx.resume();
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  if(type==="success"){ osc.frequency.value=880; gain.gain.setValueAtTime(0.2, ctx.currentTime); }
  else { osc.frequency.value=200; gain.gain.setValueAtTime(1.5, ctx.currentTime); }
  osc.start();
  osc.stop(ctx.currentTime+0.3);
}

function animateNumber(el, value){
  let start = 0;
  const duration = 1000;
  const startTime = performance.now();
  function step(time){
    const progress = Math.min((time - startTime) / duration, 1);
    const current = Math.floor(progress * value);
    el.textContent = `-${current}₽`;
    if(progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function showAnimation(type){
  const overlay=document.createElement("div");
  overlay.className="overlay";
  overlay.innerHTML = `
    <svg viewBox="0 0 100 100">
      <circle class="circle spin" cx="50" cy="50" r="45" stroke="${type==='success' ? '#8b5cf6' : '#ef4444'}" />
      <path class="check" stroke="#8b5cf6" d="M30 52 L45 70 L70 35"/>
      <path class="cross" stroke="#ef4444" d="M30 30 L70 70 M70 30 L30 70"/>
    </svg>
    <div id="msg" style="text-align:center; margin-top:2vw; font-size:6vw;"></div>
    <div id="paid-amount"></div>
  `;
  document.body.appendChild(overlay);
  setTimeout(async ()=>{
    const circle=overlay.querySelector(".circle");
    circle.classList.remove("spin");
    circle.style.opacity="0.2";

    const msgDiv = document.getElementById("msg");
    const amountDiv = document.getElementById("paid-amount");

    if(type==="success"){ 
      overlay.querySelector(".check").classList.add("draw"); 
      msgDiv.textContent = "Оплата прошла успешно!"; 
      await playBeep("success"); 
      amountDiv.style.opacity = 1;
      animateNumber(amountDiv, currentProduct.price);
    } else { 
      overlay.querySelector(".cross").classList.add("draw"); 
      msgDiv.textContent="Недостаточно средств!"; 
      await playBeep("fail"); 
    }

    setTimeout(()=>{ overlay.remove(); showHome(); },5000);
  },3000);
}

async function openInfo(){
  const info={ 
    "UserAgent": navigator.userAgent, 
    "Платформа": navigator.platform, 
    "Язык": navigator.language, 
    "Экран": screen.width+"x"+screen.height, 
    "Онлайн": navigator.onLine 
  };
  
  if(navigator.getBattery){ 
    const b=await navigator.getBattery(); 
    info["Батарея"]=Math.round(b.level*100)+"%"; 
  }

  let micStatus = "Голосовой ввод работает";
  let showMicButton = false;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(track => track.stop());
  } catch(e){
    micStatus = "Голосовой ввод не работает";
    showMicButton = true;
  }

  const modal=document.createElement("div"); 
  modal.className="modal";
  const checkHTML = SHOW_CHECK ? `<svg class="check-twitter" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#8b5cf6"/><path d="M7 13l3 3 7-7" stroke="#fff" stroke-width="2" fill="none"/></svg>` : '';

  modal.innerHTML=`<div class="modal-content">
    <h3>Данные терминала ${checkHTML}</h3>
    ${Object.entries(info).map(([k,v])=>`<div><b>${k}:</b> ${v}</div>`).join("")}
    <div><b>Голосовой ввод:</b> ${micStatus} 
      ${showMicButton ? '<button id="retry-mic" style="margin-left:2vw; cursor:pointer;">🎤</button>' : ''}
    </div>
    <button onclick="this.closest('.modal').remove()">Закрыть</button>
  </div>`;

  document.body.appendChild(modal);

  if(showMicButton){
    const btn = document.getElementById("retry-mic");
    btn.addEventListener("click", async ()=>{
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop());
        alert("Голосовой ввод теперь доступен!");
        modal.remove();
        openInfo(); 
      }catch(e){
        alert("Разрешение не предоставлено. Голосовой ввод недоступен.");
      }
    });
  }

  if(SHOW_CHECK){
    const svgEl = modal.querySelector(".check-twitter");
    svgEl.addEventListener("click",()=>{
      const infoModal=document.createElement("div");
      infoModal.className="modal";
      infoModal.innerHTML=`<div class="modal-content"><div>Этот терминал официально подтверждён компанией ouBank.</div><button onclick="this.closest('.modal').remove()">Закрыть</button></div>`;
      document.body.appendChild(infoModal);
    });
  }
}

showHome();

// Голосовое управление
function initVoiceControl(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    console.warn("Распознавание речи не поддерживается в этом браузере.");
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = "ru-RU";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = (event)=>{
    const transcript = event.results[event.results.length-1][0].transcript.trim().toLowerCase();
    if(document.querySelector(".payment")){
      if(transcript.includes("принято")){
        showAnimation("success");
      } else if(transcript.includes("отказано")){
        showAnimation("fail");
      }
    }
  };

  recognition.onerror = (e)=>console.error("Ошибка распознавания:", e);
  recognition.onend = ()=>recognition.start(); 
  recognition.start();
}

window.addEventListener("load", initVoiceControl);
</script>
</body>
</html>
